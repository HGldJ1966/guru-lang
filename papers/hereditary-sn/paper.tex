\documentclass{article}

%\usepackage{latex8}
%\usepackage{times}
\usepackage{amsmath}
\usepackage{latexsym}
\usepackage{amssymb}
\usepackage{proof}
\usepackage{url}

% \usepackage{natbib}
%  \bibpunct();A{},
%  \let\cite=\citep

\newcommand{\lam}[2]{\lambda #1 . #2}
\newcommand{\lams}[2]{\lambda^* #1 . #2}
\newcommand{\alet}[3]{\textit{let}\ #1\ :=\ #2\ \textit{in}\ #3}
\newcommand{\Thet}[1]{\lam{V}{\lam{L}{\lam{A}{\lam{O}{\lam{C}{\lam{S}{\lam{D}{#1}}}}}}}}
\newcommand{\ope}[0]{\textit{open}}
\newcommand{\swap}[0]{\textit{swap}}
\newcommand{\vcomp}[0]{\textit{vcomp}}
\newcommand{\nlambda}[0]{\bar{\lambda}}
\newcommand{\nlam}[2]{\nlambda #1 . #2}
\newcommand{\rulename}[1]{\text{\textup{\textsf{#1}}}}
\newcommand\bs{\char '134 }  % A backslash character for \tt font
\newcommand{\seq}[3]{#1 \vdash #2 : #3}
\newcommand{\eval}[0]{\Downarrow}
\newcommand{\evalj}[2]{#1\, \eval\, #2}
\newcommand{\starstar}[0]{*\negthinspace*}
\newcommand{\nat}[0]{\mathbb{N}}
\newcommand{\red}[0]{\textit{Red}}
\newcommand{\redsub}[1]{\textit{Red}(\rhd(#1))}
\newcommand{\sn}[0]{\textit{SN}}
\newcommand{\optt}{\textsc{OpTT}}

\newcommand{\rase}[1]{\ulcorner #1 \urcorner}
\newcommand{\lowr}[1]{\llcorner #1 \lrcorner}

\newcommand{\Eq}[0]{\texttt{=}}
\newcommand{\Neq}[0]{\texttt{!=}}
\newcommand{\Qeq}[0]{\stackrel{?}{=}}
\newcommand{\bang}[0]{\texttt{!}}
\newcommand{\quant}[0]{\textit{Quant}}

\newtheorem{theorem}{Theorem}
\newtheorem{definition}{Definition}
\newtheorem{lemma}{Lemma}

\newcommand{\To}{\Rightarrow}
\newcommand{\gtrans}[2]{#1 \cdot #2}
\newcommand{\gtransa}[2]{#1 \cdot_1 #2}
\newcommand{\gtransb}[2]{#1 \cdot_2 #2}
\newcommand{\gsymm}[1]{#1^{-1}}
\newcommand{\gcong}[1]{f(#1)}
\newcommand{\ginj}[1]{f^{-1}(#1)}
\newcommand{\guru}[0]{\textsc{Guru}}

\begin{document}

\title{Hereditary Normalization for Terms and Types}

\author{Aaron Stump \\
CS, The University of Iowa \\
\url{astump@acm.org}}
%astump@acm.org,mdeters@cse.wustl.edu,tws2@cec.wustl.edu,tas5@cec.wustl.edu,ewestbro@cse.wustl.edu

%\date{}

\maketitle

%\thispagestyle{empty}

\begin{abstract}
\end{abstract}

\section{Introduction}

Proofs and Types~\cite{pat}.

\section{Syntax}

Standard syntax for types and terms is given in
Figure~\ref{fig:syntax}.

\begin{figure}[p]
\begin{eqnarray*}
T & \ ::=\ & \top\ |\ T_1 \to T_2\ |\ T_1 \vee T_2 \\ \\
t & \ ::=\ & x^T\ |\ \top_I\ |\ \lambda x^T.\ t\ |\ (t_1\ t_2)\ |\ \langle i, t \rangle\ |\ \texttt{case}\ t\ \texttt{of}\ \lambda x^{T_1}.\ t_1,\ \lambda x^{T_2}. \ t_2
\end{eqnarray*}
\caption{\label{fig:syntax}Types ($T$) and Terms ($t$)}
\end{figure}

\section{General Notions}

We will write $R(x)$ for the image of binary relation $R$ on $x$; that
is, $\{ y | R(x,y) \}$.  Also, if $P$ is a predicate, we will write
$P(S)$, for $S$ a set, to indicate that $P$ holds of every element of
$S$.  Also, we write $R \circ S$ for the composition of binary
relations $S\subset A \times B$ and $R \subset B \times C$.  For use
with composition, we view a predicate on $A$ as a binary relation
between $A$ and the set $\{ \texttt{true}, \texttt{false}\}$.  The
extension of a predicate is just the set of elements for which the
predicate holds.  A relation $R$ is called \emph{progressive} with
respect to a predicate $P$ (often omitted if clear from the context)
iff for all $x$, if $P(R(x))$ then $P(x)$.

\section{Typing}

Typing rules for terms are given in Figure~\ref{fig:typing}.

\begin{figure}[p]
\begin{tabular}{ll}

\infer{x^T\ :\ T}{\ } 

&

\infer{\top_I\ :\ \top}{\ }

\\ \\

\infer{\lambda x^{T_1}.\ t\ :\ T_1 \to T_2}
      {t\ :\ T_2}

&

\infer{(t_1\ t_2)\ :\ T_2}
      {t_1\ :\ T_1 \to T_2 \ \ &\ \  t_2\ :\ T_1}

\\ \\

\infer{\langle i, t \rangle\ :\ T_1 \vee T_2}
      {t\ :\ T_i \ \ &\ \  i \in \{1,2\}}


&

\infer{\texttt{case}\ t\ \texttt{of}\ \lambda x^{T_1}. t_1, \lambda x^{T_2}. t_2\ :\ T}
      {t\ :\ T_1\vee T_2\ \  &\ \  t_1\ :\ T\ \  &\ \  t_2\ :\ T}

\end{tabular}
\caption{\label{fig:typing}Typing Rules for Terms}
\end{figure}

\section{Reduction}

Reduction rules for terms are given in Figure~\ref{fig:red}.  The
first two rules are detour-reduction rules for $\to$ and $\vee$,
which, as indicated in the figure, we refer to as $\beta(\to)$- and
$\beta(\vee)$-reduction, respectively.  The second two are commuting
conversions, which we refer to as $\textit{cc}(\to)$- and
$\textit{cc}(\vee)$-reduction, respectively.  Reduction is the
compatible closure of these rules.

\begin{figure}[p]
\[
\begin{array}{llll}
\beta(\to)\  & (\lambda x^T.\ t_1)\ t_2 & \ \leadsto\  & [t_2/x]t_1 \\ \\
\beta(\vee)\ & \texttt{case}\ \langle i, t \rangle\ \texttt{of}\ \lambda x^{T_1}. t_1, \lambda x^{T_2}. t_2 & \leadsto & 
  [t/x]t_i \\ \\
\textit{cc}(\to) &(\texttt{case}\ t\ \texttt{of}\ \lambda x^{T_1}.t_1,\lambda x^{T_2}.t_2)\ t' & \leadsto & 
  \texttt{case}\ t\ \texttt{of}\ \lambda x^{T_1}.(t_1\ t'), \lambda x^{T_2}.(t_2\ t') \\ \\
\textit{cc}(\vee) & \texttt{case}\ (\texttt{case}\ t\ \texttt{of}\ \lambda x^{T_1}.t_1,\lambda x^{T_2}.t_2) & \leadsto &\ 
\texttt{case}\ t\ \texttt{of}\ (\lambda x^{T_1}.\texttt{case}\ t_1\ \texttt{of}\ C_1, C_2),\\
\ & \texttt{of}\ C_1, C_2 \ & \ &
\ \ \ \ \ \ \ \ \ \ \ \ \ \ (\lambda x^{T_2}.\texttt{case}\ t_2\ \texttt{of}\ C_1, C_2)
\end{array}
\]
\caption{\label{fig:red}Reduction Rules}
\end{figure}

\section{Type-Hereditary Normalization}

The definition of a type-based form of hereditary normalization, based
on standard ideas of reducibility, is given in
Figure~\ref{fig:type-hn}.  The definition is by recursion on the
structure of the type subscript to \red.  It relies on a predicate
\sn\ whose extension is the set of strongly normalizing terms.  If
$\sn(t)$, we may make use of a finite bound $\nu(t)$ on the length of
all reduction sequences from $t$.  Note that in the figure, a
hereditary condition is imposed only for $\to$-types.  A hereditary
condition is usually imposed for all compound types, though
$\vee$-types are problematic.

\begin{figure}[p]
\begin{eqnarray*}
\red_{\top}(t) & \Leftrightarrow & \sn(t) \\
\red_{T_1\vee T_2}(t) & \Leftrightarrow & \sn(t) \\
\red_{T_1\to T_2}(t) & \Leftrightarrow & \forall t', \red_{T_1}(t')\ \To\ \red_{T_2}(t\ t')
\end{eqnarray*}
\caption{\label{fig:type-hn} Type-Hereditary Normalization}
\end{figure}

\noindent We also adopt the following definition of a predicate $\red$
with no subscript:

\begin{eqnarray*}
\red(t) &\ \Leftrightarrow\ & t : T\ \textnormal{and}\ \red_{T}(t)
\end{eqnarray*}

\section{Critical Properties of $\red$}
\label{sec:crit}

First, let us note the following simple property of \sn: $\sn(t)$ iff
$\sn(\leadsto(t))$.  Then very similarly to the proof in~\cite{pat},
we show the following critical properties of $\red$ for terms $t:T$.

\begin{itemize}
\item \textbf{CR1.} $\red(t) \ \To \sn(t)$.
\item \textbf{CR2.} $\red(t)\ \To\ \red(\leadsto(t))$.
\item \textbf{CR3.} If $t$ is a variable or application, or if $T$ is
not a $\to$-type, then $\red(\leadsto(t))\ \To\ \red(t)$.
\end{itemize}

The proof is by induction on the type $T$ of $t$.  We consider first
\textbf{CR1}.  When $T$ is a $\vee$-type or $\top$, \textbf{CR1}
follows immediately by definition of $\red_T$.  So suppose $T \equiv
T_1\to T_2$, and consider arbitrary $t\ :\ T_1\to T_2$ with
$\red_{T}(t)$.  By assumption, we have $\red_{T_2}(t\ t')$ for all
$t'$ with $\red_{T_1}(t')$.  In particular, this is true for a
variable $x^{T_1}$, as long as $\red_{T_1}(x^{T_1})$ holds.  We do
have $\red_{T_1}(x^{T_1})$, since $\red(\leadsto(x^{T_1}))$ holds
vacuously (since $x^{T_1}$ has no $\leadsto$-successors), and so we
may apply \textbf{CR3} at smaller type $T_1$.  By \textbf{CR1} at
smaller type $T_2$, we have $\sn(t\ x^{T_1})$, which implies $\sn(t)$.

Now consider \textbf{CR2}.  When $T$ is $\top$ or $\vee$, we have
$\red_T(t)$ iff $\red_T(\leadsto(t))$ for all $t:T$, from the similar
property of $\sn$, noted above.  So consider the case when $T\equiv
T_1\to T_2$, and consider arbitrary $t:T$.  First suppose
$\red_{T}(t)$, and show $\red_T(\leadsto(t))$.  So consider arbitrary
$t'$ with $t\leadsto t'$, and show $\red_T(t')$.  For this, we
consider an arbitrary $t''$ with $\red_{T_1}(t'')$, and we must show
$\red_{T_2}(t'\ t'')$.  We certainly have $(t\ t'')\leadsto (t'\
t'')$, since $t\leadsto t'$.  From the assumption that $\red_{T}(t)$,
we have $\red_{T_2}(t\ t'')$.  Then by \textbf{CR2} at smaller type
$T_2$, we get the desired $\red_{T_2}(t'\ t'')$.  

Finally, consider \textbf{CR3}: If $T$ is not a $\to$-type, then the
statement follows directly from the progressiveness of $\sn$.  So
assume $\red_T(\leadsto(t))$, and $t$ of the required form, and show
$\red_T(t)$.  For this, consider arbitrary $t''$ with
$\red_{T_1}(t'')$, and show $\red_{T_2}(t\ t'')$.  To show this, it
suffices to show $\red_{T_2}(\leadsto(t\ t''))$, by \textbf{CR3} at
smaller type $T_2$.  So consider arbitrary $t'$ with $(t\ t'')\leadsto
t'$.  We proceed by inner induction on $\nu(t'')$, which exists by
\textbf{CR1} at smaller type $T_1$.  If $t' \equiv (t_a\ t'')$ with
the reduction due to $t\leadsto t_a$, then by assumption $\red_{T_1\to
T_2}(t_a)$, and so $\red_{T_2}(t_a\ t'')$.  Otherwise, the only
possibility, by the form of $t$, is that $t' \equiv (t\ t_a)$, with
$t'' \leadsto t_a$.  We have $\red_{T_1}(t_a)$ by \textbf{CR2} at
smaller type $T_1$.  We conclude $\red_{T_2}(t\ t_a)$ by the inner
induction hypothesis, which applies since the maximal length of a
reduction of $t_a$ is strictly less than that of $t''$.

\section{Term-Hereditary Normalization}

Informally, a term is defined to be term-hereditarily normalizing iff
all its subterms are type-hereditarily normalizing at their types.
Write $t' \rhd t$ iff $t$ is a subterm of $t'$.  Following our general
notations above, this predicate of term-hereditary normalization may
be written as just $\red \circ \rhd$.

\section{Term-Construction Closure of $\red \circ \rhd$}

Before we can prove $\red_T(t)$ for all $t : T$, we will establish
certain closure properties of the extension of $\red \circ \rhd$.  In
particular, we prove in this section that it is closed under all our
term-forming constructs.  The most interesting case is for
$\vee$-elimination.  A stronger assumption is needed in the $\lambda$
case.  The lemmas below go from hypotheses about the membership of
immediate subterms in the extension of $\red$ to a conclusion that a
term constructed from those immediate subterms is in the extension of
$\red$.  That is then sufficient to show that $\red \circ \rhd$ is
preserved by term-forming constructs, since all proper subterms of the
constructed term are subterms of its immediate subterms.

\begin{lemma}
$\redsub{x^T}$.
\end{lemma}

\noindent Since $x^T$ has no proper subterms, this follows easily from
the fact that $\red{x^T}$, a special case of \textbf{CR3} (used
already in the proof in Section~\ref{sec:crit}).

\begin{lemma}
Suppose that $\red_{T_1\to T_2}{t_1}$ and $\red_{T_1}{t_2}$.  Then
also $\red_{T_2}(t_1\ t_2)$.
\end{lemma}

\noindent We get $\red_{T_2}(t_1\ t_2)$ from the definition of
type-hereditary normalization for $\to$-types.

\begin{lemma}
If for some $i\in\{1,2\}$, we have $\red_{T_i}{t}$, then we also have
$\red{\langle i,t\rangle}$.
\end{lemma}

\noindent To show $\red_{T_1\vee T_2}(\langle i,t\rangle)$, we must
just show $\sn(\langle i,t\rangle)$, which follows from $\sn(t)$.  The
latter fact follows, of course, from \textbf{CR1}.  

\begin{lemma}
\label{lem:lambda}
Suppose that for all $t'$ with $\red_{T_1}(t')$,
$\red_{T_2}([t'/x]t)$.  Then we also have $\red_{T_1 \to T_2}{\lambda x^{T_1}. t}$.
\end{lemma}

\noindent We obtain $\red_{T_2}(t)$ by the assumption (call it the
instantiation assumption), with $x^{T_1}$.  To show $\red_{T_1\to
T_2}(\lambda x^{T_1}.t)$, it suffices to assume an arbitrary $t'$ with
$\red_{T_1}(t')$, and show $\red_{T_2}((\lambda x^{T_1}.t)\ t')$.  We
will now show for all $t$ satisfying the instantiation assumption and
where $\nu(t)$ exists, and for all $t'$ with $\red_{T_1}(t')$ and
where $\nu(t')$ exists , we have with $\red{T_2}((\lambda x^{T_1}.t)\
t')$.  This will suffice to prove the desired $\red{T_2}((\lambda
x^{T_1}.t)\ t')$, since we have $\nu(t)$ and $\nu(t')$ by \textbf{CR1}
and our assumptions.  The proof is by induction on the sum
$\nu(t)+\nu(t')$.  Suppose we have the reduction $((\lambda
x^{T_1}.t)\ t')\leadsto ((\lambda x^{T_1}. t_a)\ t_b)$, for some $t_a$
and $t_b$, due either to $t\leadsto t_a$ or $t' \leadsto t_b$.  In
either case, we have $\red(t_a)$ and $\red(t_b)$ by \textbf{CR2}.
Also, we can prove the instantiation assumption for $t_a$ as follows.
Assume an arbitrary $t''$ with $\red_{T_1}(t'')$.  We must show
$\red_{T_2}([t''/x]t_a)$.  We have $\red_{T_2}([t''/x]t)$ by the
instantiation assumption for $t$.  We also have $[t''/x]t \leadsto
[t''/x]t_a$, and so by \textbf{CR2} we get the desired
$\red_{T_2}([t''/x]t_a)$.  So the instantiation assumption holds for
$t_a$, and the induction hypothesis applies to show $\red_{T_2}(t_a\
t_b)$.  Suppose now that instead of a reduction in $t$ or $t'$ we have
the top-level $\beta(\to)$-reduction $((\lambda x^{T_1}.t)\ t')\leadsto
[t'/x]t$.  In this case, the instantiation assumption may be applied
to conclude the required $\red_{T_2}([t'/x]t)$.  So
$\red_{T_2}(\leadsto((\lambda x^{T_1}.t)\ t'))$, from which we
conclude $\red_{T_2}((\lambda x^{T_1}.t)\ t')$ by \textbf{CR3}, which
applies since the term in question is an application.

\begin{lemma}
\label{lem:red-inst}
Suppose $\red_{T_1\to T_2}(\lambda x^{T_1}.t)$.  Then for all
$t'$ with $\red_{T_1}(t')$, we have $\red_{T_2}([t'/x]t)$.
\end{lemma}

\noindent We have, of course, $\red_{T_2}((\lambda x^{T_1}.t)\ t')$.
We then get the desired result by \textbf{CR2}, since $(\lambda
x^{T_1}.t)\ t'\leadsto [t'/x]t$.

\begin{lemma}
Suppose that the following conditions hold.
\begin{itemize} 
\item $t\ :\ T_1\vee T_2$
\item $\redsub{t}$
\item $C_1\ :\ T_1\to T$
\item $\redsub{C_1}$
\item $C_2\ :\ T_2\to T$
\item $\redsub{C_2}$
\end{itemize}
Then we also have $\red_{T}(\texttt{case}\ t\ \texttt{of}\ C_1,C_2)$.
\end{lemma}

\noindent Let $e(t)$ be the \texttt{case}-nesting depth of $t$, which
is a finite number since $\red{t}$.  The proof is by well-founded
induction on the metric $(e(t),T)$, in the lexicographic combination of
the subterm and usual less-than ordering on the natural numbers.  If
$T$ is a $\vee$-type or $\top$, we prove the desired conclusion for
all $t$, $C_1$, and $C_2$ satisfying the above conditions, by
induction on the sum $\nu(t)+\nu(C_1)+\nu(C_2)$.  If a reduction of
the \texttt{case}-term occurs due to a reduction in its proper
subterms, then by the induction hypothesis (applicable by
\texttt{CR2}), the resulting \texttt{case}-term is in the extension of
$\red_{T}$.  If a top-level $\beta(\vee)$-reduction takes place due to
having $t\equiv \langle i, t'\rangle$, then by $\redsub{t}$ we have
$\red_{T_i}(t')$.  We also have $\red_{T_i\to T}(C_i)$.  So by
Lemma~\ref{lem:red-inst}, we have $\red_T([t'/x]C_i)$.  Finally,
suppose a top-level $\textit{cc}(\vee)$-reduction takes place, as
follows:

\[
\begin{array}{lll}
\texttt{case}\ (\texttt{case}\ t'\ \texttt{of}\ \lambda x^{T_1}.t_1,\lambda x^{T_2}.t_2) & \leadsto &\ 
\texttt{case}\ t'\ \texttt{of}\ (\lambda x^{T_1}.\texttt{case}\ t_1\ \texttt{of}\ C_1, C_2),\\
\texttt{of}\ C_1, C_2 \ & \ &
\ \ \ \ \ \ \ \ \ \ \ \ \ \ (\lambda x^{T_2}.\texttt{case}\ t_2\ \texttt{of}\ C_1, C_2)
\end{array}
\]

\noindent Since $e(t_i) < e(t)$ for all $i\in\{1,2\}$, we may apply
the induction hypothesis to $\texttt{case}\ t_i\ \texttt{of}\ C_1,
C_2$, to conclude $\red(\texttt{case}\ t_i\ \texttt{of}\ C_1, C_2)$,
for all $i\in\{1,2\}$.  We wish to apply Lemma~\ref{lem:lambda} to
conclude $\red(\lambda x^{T_i}. \texttt{case}\ t_i\ \texttt{of}\ C_1,
C_2)$ for all $i\in\{1,2\}$.  To do this, consider arbitrary
$i\in\{1,2\}$, and prove that for all $t'$ with $\red_{T_i}(t')$, we
have $\red([t'/x]\texttt{case}\ t_i\ \texttt{of}\ C_1, C_2)$.  So
let $t'$ be an arbitrary term with $\red_{T_i}(t')$.  By Lemma~\ref{lem:red-inst},
we have 

% ### badly stuck here.  Probably the method won't work.


$\red(\lambda x^{T_i}.t_i)$, for all $i\in\{1,2\}$.  
Now since $e(t') < e(t)$, we may again apply
the induction hypothesis to get that the resulting term is in the
extension of \red.

Since the above are all the possibilities for a reduction of the
\texttt{case}-term, we see that $\red_{T}(\leadsto(\texttt{case}\ t\
\texttt{of}\ C_1,C_2))$.  By \textbf{CR3}, which applies since $T$ is
not a $\vee$-type, we have the required $\red_{T}(\texttt{case}\ t\
\texttt{of}\ C_1,C_2)$.

Suppose now that $T$ is of the form $T_1\to T_2$.  It suffices to
assume arbitrary $t'$ with $\red_{T_1}(t')$, and show
$\red_{T_2}((\texttt{case}\ t\ \texttt{of}\ C_1,C_2)\ t')$.  We again
proceed by induction on the sum $\nu(t)+\nu(C_1)+\nu(C_2)+\nu(t')$.
If a reduction occurs due to a reduction in $t$, $C_1$, $C_2$, or
$t'$, we apply the induction hypothesis to conclude that the resulting
\texttt{case}-term is in the extension of $\red_{T_2}$.  Suppose we
have a $\beta(\vee)$- or a $\textit{cc}(\vee)$-reduction of
$\texttt{case}\ t\ \texttt{of}\ C_1,C_2$.  Then similar reasoning as
in the previous case shows that the resulting \texttt{case}-term --
call it $\hat{t}$ -- is in the extension of $\red_{T_1\to T_2}$.  We
then get $\red(\hat{t}\ t')$ from the definition of $\red_{T_1\to
T_2}$.  Finally, suppose we have a commuting conversion

\[
(\texttt{case}\ t\ \texttt{of}\ \lambda x^{T'_1}.t_1,\lambda x^{T'_2}.t_2)\ t' \leadsto 
  \texttt{case}\ t\ \texttt{of}\ \lambda x^{T'_1}.(t_1\ t'), \lambda x^{T'_2}.(t_2\ t') 
\]

\noindent It is sufficient to show for all $i\in\{1,2\}$, $\red_{T'_1
\to T_2}(\lambda x^{T'_i}.(t_i\ t'))$.  For from this we may obtain
that the resulting \texttt{case}-term is in the extension of
$\red_{T_2}$ by the induction hypothesis, since the type of this
\texttt{case}-term is $T_2$, which is smaller than the type $T_1\to
T_2$ of the original \texttt{case}-term.  Note that $e(t)$ has not
changed, so the metric indeed decreases in the lexicographic
combination.  We have $\red_{T_2}(t_i\ t')$, for all $i\in\{1,2\}$,
from $\red_{T_1\ to T_2}(t_i)$.  




\bibliographystyle{plain}

%\nocite{SH80}
\bibliography{partiality,misc_logic,automated_reasoning,formal_methods,verification,lf,general,refinement,coop_dec_procs,cl,rewriting,theorem_provers,sat,program_analysis,software_engineering,specification,pl,stanford_group,hoas,semantic_programming,misc}



\end{document}
